<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anand Tasks Board</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to right bottom, #e0f7fa, #c8e6c9);
            min-height: 100vh;
            display: flex;
            align-items: flex-start; /* Align to start for scrolling if content is tall */
            justify-content: center;
            /* Optimized padding for full screen - more controlled horizontal padding */
            padding-top: 2rem; /* py-8 */
            padding-bottom: 2rem; /* py-8 */
            padding-left: 1rem; /* px-4 */
            padding-right: 1rem; /* px-4 */
        }
        /* Responsive horizontal padding for body */
        @media (min-width: 768px) { /* md breakpoint */
            body {
                padding-left: 2rem; /* md:px-8 */
                padding-right: 2rem; /* md:px-8 */
            }
        }
        @media (min-width: 1024px) { /* lg breakpoint */
            body {
                padding-left: 4rem; /* lg:px-16 */
                padding-right: 4rem; /* lg:px-16 */
            }
        }
        @media (min-width: 1280px) { /* xl breakpoint */
            body {
                padding-left: 8rem; /* xl:px-32 */
                padding-right: 8rem; /* xl:px-32 */
            }
        }

        .task-item {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease-in-out;
            width: 100%; /* Ensure full width within its container */
        }
        .task-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.06);
        }
        .task-content {
            flex-grow: 1;
            width: 100%;
            margin-bottom: 0.5rem;
            word-break: break-word;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .task-text {
            font-size: 1.125rem;
            color: #1f2937;
            line-height: 1.4;
        }
        .task-deadline {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        .task-notes {
            font-size: 0.875rem;
            color: #4b5563;
            margin-top: 0.5rem;
            background-color: #f9fafb;
            padding: 0.5rem;
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb;
            white-space: pre-wrap;
            width: 100%;
            box-sizing: border-box;
        }
        .task-category {
            font-size: 0.75rem;
            color: #4f46e5;
            background-color: #e0e7ff;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            margin-left: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
            align-self: flex-start;
        }
        .task-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            width: 100%;
            justify-content: flex-end;
            margin-top: 0.5rem;
        }
        .task-actions button {
            padding: 0.4rem 0.8rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
        }
        .task-actions button:hover {
            opacity: 0.9;
        }
        /* Category Header Styling */
        .category-header {
            font-size: 1.25rem;
            font-weight: 600;
            color: #4b5563;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            padding-left: 0.5rem;
            border-left: 4px solid;
            display: flex;
            align-items: center;
        }
        .current-day-category-border {
            border-color: #60a5fa; /* Blue */
        }
        .most-urgent-category-border {
            border-color: #f87171; /* Red */
        }
        .date-wise-category-border {
            border-color: #9ca3af; /* Gray */
        }
        .completed-category-border {
            border-color: #34d399; /* Green */
        }
        /* Dashboard Section Backgrounds for distinction */
        #currentDayTasksSection {
            background-color: #e3f2fd; /* Light Blue */
        }
        #mostUrgentTasksSection {
            background-color: #ffebee; /* Light Red */
        }
        #dateWiseTasksSection {
            background-color: #f5f5f5; /* Very Light Gray */
        }
        #completedTasksSection {
            background-color: #e8f5e9; /* Light Green */
        }

        /* Ensure input fields take full width on small screens */
        .mb-8 > .flex-grow {
            width: 100%;
        }
        @media (min-width: 640px) {
            .mb-8 > .flex-grow {
                width: auto;
            }
        }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto; /* Centered */
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center px-4 py-8 md:px-8 lg:px-16 xl:px-32">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full"> <h1 class="text-4xl font-bold text-center text-gray-800 mb-8">Anand Tasks Board</h1>

        <div class="text-center text-sm text-gray-500 mb-2">
            User ID: <span id="userIdDisplay" class="font-mono text-gray-700">Loading...</span>
        </div>
        <div id="statusMessage" class="text-center text-sm text-blue-600 mb-4">
            Initializing app...
        </div>

        <div class="mb-8 flex flex-col sm:flex-row gap-4 flex-wrap">
            <input type="text" id="newTaskInput" placeholder="Add a new task..."
                   class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700">
            <input type="date" id="taskDeadlineInput"
                   class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700">
            <select id="taskCategoryInput"
                    class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700">
                <option value="General">General</option>
                <option value="AP-FT">AP-FT</option>
                <option value="REC">REC</option>
                <option value="Upwork">Upwork</option>
                <option value="Bambio">Bambio</option>
                <option value="Personal">Personal</option>
                <option value="Other">Other</option>
                <option value="PhD-Anand">PhD-Anand</option>
            </select>
            <button id="addTaskBtn"
                    class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 ease-in-out shadow-md">
                Add Task
            </button>
        </div>

        <div class="mb-8 text-center">
            <button id="exportTasksBtn"
                    class="bg-gray-700 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-700 focus:ring-offset-2 transition duration-200 ease-in-out shadow-md">
                Export All Tasks to CSV
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-4 gap-6"> <div id="mostUrgentTasksSection" class="p-6 rounded-lg shadow-inner">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center">
                    Most Urgent Tasks
                    <svg class="ml-2 w-6 h-6 text-red-500" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M12 2.25c-3.328 0-6 2.672-6 6 0 2.658 1.487 4.908 3.704 6.162-.193.303-.503.565-.873.743A9.766 9.766 0 003 18.75c0 1.036.84 1.875 1.875 1.875h14.25c1.036 0 1.875-.84 1.875-1.875 0-1.574-.783-2.915-1.99-3.794a3.39 3.39 0 00-.702-.455c2.217-1.254 3.704-3.504 3.704-6.162 0-3.328-2.672-6-6-6zm-1.75 8.75a.75.75 0 001.5 0v-6a.75.75 0 00-1.5 0v6z" clip-rule="evenodd" />
                    </svg>
                </h2>
                <div id="mostUrgentTasksList" class="space-y-3">
                    </div>
                <p id="noMostUrgentTasks" class="text-gray-500 text-center mt-4 hidden">No urgent tasks!</p>
            </div>

            <div id="currentDayTasksSection" class="p-6 rounded-lg shadow-inner">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center">
                    Current Day Tasks (<span id="currentDayDate"></span>)
                    <svg class="ml-2 w-6 h-6 text-yellow-500" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.106a.75.75 0 00-1.06-1.06l-1.59 1.59a.75.75 0 101.06 1.06l1.59-1.59zM12 18a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V18a.75.75 0 01.75-.75zM5.656 17.344a.75.75 0 001.06-1.06l-1.59-1.59a.75.75 0 10-1.06 1.06l1.59 1.59zM3 12a.75.75 0 01.75-.75h2.25a.75.75 0 010 1.5H3.75A.75.75 0 013 12zM17.344 5.656a.75.75 0 00-1.06 1.06l1.59 1.59a.75.75 0 101.06-1.06l-1.59-1.59zM12 3a9 9 0 100 18 9 9 0 000-18z" />
                    </svg>
                </h2>
                <div id="currentDayTasksList" class="space-y-3">
                    </div>
                <p id="noCurrentDayTasks" class="text-gray-500 text-center mt-4 hidden">No tasks for today!</p>
            </div>

            <div id="dateWiseTasksSection" class="mt-8 p-6 rounded-lg shadow-inner">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center">
                    Tasks by Date
                    <svg class="ml-2 w-6 h-6 text-indigo-500" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M6.75 2.25A.75.75 0 017.5 3v1.5h9V3A.75.75 0 0118 3v1.5h.75A2.25 2.25 0 0121 6.75v10.5A2.25 2.25 0 0118.75 19.5H5.25A2.25 2.25 0 013 17.25V6.75A2.25 2.25 0 015.25 4.5H6.75V3a.75.75 0 01.75-.75zm10.5 6a.75.75 0 01.75.75v5.25a.75.75 0 01-1.5 0V9a.75.75 0 01.75-.75z" clip-rule="evenodd" />
                    </svg>
                </h2>
                <div id="dateWiseTasksList" class="space-y-3">
                    </div>
                <p id="noDateWiseTasks" class="text-gray-500 text-center mt-4 hidden">No future tasks!</p>
            </div>

            <div id="completedTasksSection" class="mt-8 p-6 rounded-lg shadow-inner">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center">
                    Completed Tasks
                    <svg class="ml-2 w-6 h-6 text-green-500" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm13.36-1.814a.75.75 0 10-1.22-.872l-3.236 4.532-1.267-1.267a.75.75 0 00-1.06 1.06l1.75 1.75a.75.75 0 001.135-.082l3.75-5.25z" clip-rule="evenodd" />
                    </svg>
                </h2>
                <div id="completedTasksList" class="space-y-3">
                    </div>
                <p id="noCompletedTasks" class="text-gray-500 text-center mt-4 hidden">No completed tasks yet!</p>
            </div>
        </div>
    </div>

    <div id="notesModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="window.closeNotesModal()">&times;</span>
            <h3 class="text-2xl font-semibold text-gray-800 mb-4">Edit Notes</h3>
            <textarea id="editNotesTextarea" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700 resize-y h-40 mb-4"></textarea>
            <button onclick="window.saveNotes()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 ease-in-out shadow-md">
                Save Notes
            </button>
        </div>
    </div>

    <script type="module">
        // Firebase SDK Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, onSnapshot, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables (provided by the Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // User-provided Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDNGaeo3jNhp5EImaZMBPEalq2ZvLw8XxQ",
            authDomain: "task-tracker-f77f1.firebaseapp.com",
            projectId: "task-tracker-f77f1",
            storageBucket: "task-tracker-f77f1.firebasestorage.app",
            messagingSenderId: "1096145801568",
            appId: "1:1096145801568:web:7f35bab25471a555434e05", // Your specific Firebase App ID
            measurementId: "G-4T4829KXPH"
        };

        let app;
        let db;
        let auth;
        let currentUserId = null;
        let authReady = false;
        let allTasksData = []; // Store all tasks for export

        // Get references to DOM elements
        const newTaskInput = document.getElementById('newTaskInput');
        const taskDeadlineInput = document.getElementById('taskDeadlineInput');
        const taskCategoryInput = document.getElementById('taskCategoryInput');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const exportTasksBtn = document.getElementById('exportTasksBtn');

        const currentDayTasksList = document.getElementById('currentDayTasksList');
        const mostUrgentTasksList = document.getElementById('mostUrgentTasksList');
        const dateWiseTasksList = document.getElementById('dateWiseTasksList');
        const completedTasksList = document.getElementById('completedTasksList');

        const noCurrentDayTasksMessage = document.getElementById('noCurrentDayTasks');
        const noMostUrgentTasksMessage = document.getElementById('noMostUrgentTasks');
        const noDateWiseTasksMessage = document.getElementById('noDateWiseTasks');
        const noCompletedTasksMessage = document.getElementById('noCompletedTasks');

        const userIdDisplay = document.getElementById('userIdDisplay');
        const statusMessage = document.getElementById('statusMessage');
        const currentDayDateDisplay = document.getElementById('currentDayDate');


        const notesModal = document.getElementById('notesModal');
        const editNotesTextarea = document.getElementById('editNotesTextarea');
        let currentTaskItemForNotes = null;

        // --- Firebase Initialization and Authentication ---
        async function initializeFirebase() {
            console.log("Attempting to initialize Firebase.");
            statusMessage.textContent = "Authenticating...";

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase app, db, auth initialized.");

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userIdDisplay.textContent = currentUserId;
                        authReady = true;
                        console.log("onAuthStateChanged: User authenticated. UID:", currentUserId);
                        statusMessage.textContent = "App ready! User: " + currentUserId.substring(0, 8) + "...";
                        listenForTasks();
                    } else {
                        console.log("onAuthStateChanged: No user detected. Attempting anonymous sign-in.");
                        statusMessage.textContent = "Authenticating anonymously...";
                        try {
                            await signInAnonymously(auth);
                            console.log("onAuthStateChanged: Anonymous sign-in attempt completed.");
                        } catch (authError) {
                            console.error("onAuthStateChanged: Authentication error:", authError);
                            statusMessage.textContent = "Authentication failed!";
                            userIdDisplay.textContent = "Auth Error";
                        }
                    }
                });

            } catch (error) {
                console.error("Error during Firebase initialization or auth setup:", error);
                userIdDisplay.textContent = "Init Error";
                statusMessage.textContent = "Initialization failed!";
            }
        }

        // --- Firestore Real-time Listener ---
        function listenForTasks() {
            if (!db || !currentUserId) {
                console.warn("Firestore or User ID not ready for listening. Cannot set up snapshot listener.");
                return;
            }

            const tasksCollectionRef = collection(db, `artifacts/${appId}/public/data/tasks`);
            console.log("Setting up Firestore real-time listener for public path:", `artifacts/${appId}/public/data/tasks`);

            onSnapshot(tasksCollectionRef, (snapshot) => {
                console.log("Firestore snapshot received. Number of documents:", snapshot.size);
                currentDayTasksList.innerHTML = '';
                mostUrgentTasksList.innerHTML = '';
                dateWiseTasksList.innerHTML = '';
                completedTasksList.innerHTML = '';

                const tasks = [];
                snapshot.forEach(doc => {
                    tasks.push({ id: doc.id, ...doc.data() });
                });

                allTasksData = tasks; // Store all tasks for export

                // Sort tasks primarily by deadline, then by creation date
                tasks.sort((a, b) => {
                    const dateA = a.deadline ? new Date(a.deadline + 'T00:00:00') : new Date('9999-12-31T00:00:00');
                    const dateB = b.deadline ? new Date(b.deadline + 'T00:00:00') : new Date('9999-12-31T00:00:00');

                    if (dateA < dateB) return -1;
                    if (dateA > dateB) return 1;

                    const createdAtA = a.createdAt ? a.createdAt.toDate() : new Date(0);
                    const createdAtB = b.createdAt ? b.createdAt.toDate() : new Date(0);
                    if (createdAtA < createdAtB) return -1;
                    if (createdAtA > createdAtB) return 1;

                    return 0;
                });

                const today = new Date();
                const todayFormatted = today.toISOString().split('T')[0];
                currentDayDateDisplay.textContent = today.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' });


                const currentDayTasks = {};
                const mostUrgentTasks = {};
                const dateWiseTasks = {}; // Will store tasks grouped by date
                const completedTasks = {};

                tasks.forEach(taskData => {
                    const category = taskData.category || 'General';

                    if (taskData.isCompleted) {
                        if (!completedTasks[category]) completedTasks[category] = [];
                        completedTasks[category].push(taskData);
                    } else if (taskData.isUrgent) {
                        if (!mostUrgentTasks[category]) mostUrgentTasks[category] = [];
                        mostUrgentTasks[category].push(taskData);
                    } else if (taskData.deadline === todayFormatted) {
                        if (!currentDayTasks[category]) currentDayTasks[category] = [];
                        currentDayTasks[category].push(taskData);
                    } else {
                        // All other non-urgent, non-completed tasks
                        const deadlineDate = taskData.deadline || 'No Date';
                        if (!dateWiseTasks[deadlineDate]) dateWiseTasks[deadlineDate] = {};
                        if (!dateWiseTasks[deadlineDate][category]) dateWiseTasks[deadlineDate][category] = [];
                        dateWiseTasks[deadlineDate][category].push(taskData);
                    }
                });

                // Render Most Urgent Tasks
                renderTasksSection(mostUrgentTasks, mostUrgentTasksList, 'most-urgent-category-border');
                noMostUrgentTasksMessage.classList.toggle('hidden', Object.keys(mostUrgentTasks).length > 0 || mostUrgentTasksList.children.length > 0);


                // Render Current Day Tasks
                renderTasksSection(currentDayTasks, currentDayTasksList, 'current-day-category-border');
                noCurrentDayTasksMessage.classList.toggle('hidden', Object.keys(currentDayTasks).length > 0 || currentDayTasksList.children.length > 0);

                // Render Date Wise Tasks
                const sortedDates = Object.keys(dateWiseTasks).sort((a, b) => {
                    if (a === 'No Date') return 1; // "No Date" always last
                    if (b === 'No Date') return -1; // "No Date" always last
                    return new Date(a) - new Date(b);
                });

                sortedDates.forEach(date => {
                    const dateHeader = document.createElement('h3');
                    dateHeader.classList.add('category-header', 'date-wise-category-border');
                    dateHeader.textContent = date === 'No Date' ? 'No Due Date' : new Date(date + 'T00:00:00').toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' });
                    dateWiseTasksList.appendChild(dateHeader);

                    const sortedCategories = Object.keys(dateWiseTasks[date]).sort();
                    sortedCategories.forEach(category => {
                        const categoryHeader = document.createElement('h4'); // Use h4 for sub-category headers
                        categoryHeader.classList.add('text-lg', 'font-semibold', 'text-gray-600', 'mt-3', 'mb-2', 'pl-2', 'border-l-2', 'border-gray-400');
                        categoryHeader.textContent = category;
                        dateWiseTasksList.appendChild(categoryHeader);

                        dateWiseTasks[date][category].forEach(taskData => {
                            const taskItem = createTaskElement(
                                taskData.text,
                                taskData.deadline,
                                taskData.notes,
                                taskData.category,
                                taskData.isUrgent, // Pass isUrgent
                                taskData.isCompleted,
                                taskData.id
                            );
                            dateWiseTasksList.appendChild(taskItem);
                        });
                    });
                });
                noDateWiseTasksMessage.classList.toggle('hidden', Object.keys(dateWiseTasks).length > 0 || dateWiseTasksList.children.length > 0);


                // Render Completed Tasks
                renderTasksSection(completedTasks, completedTasksList, 'completed-category-border');
                noCompletedTasksMessage.classList.toggle('hidden', Object.keys(completedTasks).length > 0 || completedTasksList.children.length > 0);

                console.log("UI updated with tasks.");
            }, (error) => {
                console.error("Error listening to tasks:", error);
                if (error.code === 'permission-denied' || error.message.includes('Missing or insufficient permissions')) {
                    statusMessage.textContent = "Error: Permission denied! Check Firestore Rules.";
                    console.error("Firestore Permission Error: Please ensure your Firestore Security Rules allow read/write access for authenticated users to the public task collection.");
                    console.error("Example Rule: allow read, write: if request.auth != null;");
                } else {
                    statusMessage.textContent = "Error loading tasks!";
                }
            });
        }

        function renderTasksSection(tasksByCategory, targetElement, borderColorClass) {
            const sortedCategories = Object.keys(tasksByCategory).sort();
            sortedCategories.forEach(category => {
                const categoryHeader = document.createElement('h3');
                categoryHeader.classList.add('category-header', borderColorClass);
                categoryHeader.textContent = category;
                targetElement.appendChild(categoryHeader);

                tasksByCategory[category].forEach(taskData => {
                    const taskItem = createTaskElement(
                        taskData.text,
                        taskData.deadline,
                        taskData.notes,
                        taskData.category,
                        taskData.isUrgent,
                        taskData.isCompleted,
                        taskData.id
                    );
                    targetElement.appendChild(taskItem);
                });
            });
        }

        // Function to create a new task element (UI only)
        function createTaskElement(taskText, deadline = '', notes = '', category = 'General', isUrgent = false, isCompleted = false, docId = null) {
            const taskItem = document.createElement('div');
            taskItem.classList.add('task-item');
            taskItem.dataset.completed = isCompleted;
            taskItem.dataset.urgent = isUrgent; // New dataset for urgent status
            taskItem.dataset.deadline = deadline;
            taskItem.dataset.notes = notes;
            taskItem.dataset.category = category;
            taskItem.dataset.docId = docId;

            const taskContentDiv = document.createElement('div');
            taskContentDiv.classList.add('task-content');

            const taskSpan = document.createElement('span');
            taskSpan.classList.add('task-text', 'block');
            taskSpan.textContent = taskText;
            taskContentDiv.appendChild(taskSpan);

            if (deadline) {
                const deadlineSpan = document.createElement('span');
                deadlineSpan.classList.add('task-deadline', 'block');
                const date = new Date(deadline + 'T00:00:00');
                deadlineSpan.textContent = `Due: ${date.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' })}`;
                taskContentDiv.appendChild(deadlineSpan);
            }

            if (category && category !== 'General') {
                const categorySpan = document.createElement('span');
                categorySpan.classList.add('task-category');
                categorySpan.textContent = category;
                taskContentDiv.appendChild(categorySpan);
            }

            const notesDisplayDiv = document.createElement('div');
            notesDisplayDiv.classList.add('task-notes', 'hidden');
            if (notes) {
                notesDisplayDiv.textContent = notes;
                notesDisplayDiv.classList.remove('hidden');
            }
            taskContentDiv.appendChild(notesDisplayDiv);

            taskItem.appendChild(taskContentDiv);

            const actionsDiv = document.createElement('div');
            actionsDiv.classList.add('task-actions', 'flex-shrink-0');

            const completeBtn = document.createElement('button');
            completeBtn.textContent = isCompleted ? 'Undo' : 'Complete';
            completeBtn.classList.add(
                isCompleted ? 'bg-yellow-500' : 'bg-green-500',
                'text-white',
                isCompleted ? 'hover:bg-yellow-600' : 'hover:bg-green-600',
                'focus:outline-none',
                'focus:ring-2',
                'focus:ring-offset-2',
                isCompleted ? 'focus:ring-yellow-500' : 'focus:ring-green-500'
            );
            completeBtn.onclick = () => toggleComplete(taskItem);
            actionsDiv.appendChild(completeBtn);

            // Add Move to Urgent/Remove from Urgent button, only if not completed
            if (!isCompleted) {
                const urgentBtn = document.createElement('button');
                urgentBtn.textContent = isUrgent ? 'Remove from Urgent' : 'Move to Urgent';
                urgentBtn.classList.add(
                    isUrgent ? 'bg-indigo-500' : 'bg-red-500', // Different colors for distinction
                    'text-white',
                    isUrgent ? 'hover:bg-indigo-600' : 'hover:bg-red-600',
                    'focus:outline-none',
                    'focus:ring-2',
                    'focus:ring-offset-2',
                    isUrgent ? 'focus:ring-indigo-500' : 'focus:ring-red-500'
                );
                urgentBtn.onclick = () => toggleUrgent(taskItem);
                actionsDiv.appendChild(urgentBtn);
            }
            
            const editNotesBtn = document.createElement('button');
            editNotesBtn.textContent = 'Edit Notes';
            editNotesBtn.classList.add(
                'bg-gray-500',
                'text-white',
                'hover:bg-gray-600',
                'focus:outline-none',
                'focus:ring-2',
                'focus:ring-offset-2',
                'focus:ring-gray-500'
            );
            editNotesBtn.onclick = () => openNotesModal(taskItem);
            actionsDiv.appendChild(editNotesBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            deleteBtn.classList.add(
                'bg-red-500',
                'text-white',
                'hover:bg-red-600',
                'focus:outline-none',
                'focus:ring-2',
                'focus:ring-offset-2',
                'focus:ring-red-500'
            );
            deleteBtn.onclick = () => deleteTask(taskItem);
            actionsDiv.appendChild(deleteBtn);

            taskItem.appendChild(actionsDiv);
            return taskItem;
        }

        // --- Firestore Data Operations ---

        async function addTask() {
            console.log("Attempting to add task...");
            if (!authReady) {
                console.error("addTask: Authentication not ready. Cannot add task.");
                statusMessage.textContent = "App not ready. Please wait.";
                alert("Please wait for the app to initialize.");
                return;
            }
            console.log("addTask: Auth is ready. currentUserId:", currentUserId);

            const taskText = newTaskInput.value.trim();
            const taskDeadline = taskDeadlineInput.value;
            const taskCategory = taskCategoryInput.value;
            const taskNotes = ''; // New tasks start with empty notes

            if (taskText === '') {
                alert('Please enter a task!');
                return;
            }

            try {
                const tasksCollectionRef = collection(db, `artifacts/${appId}/public/data/tasks`);
                const docRef = await addDoc(tasksCollectionRef, {
                    text: taskText,
                    deadline: taskDeadline,
                    notes: taskNotes,
                    category: taskCategory,
                    isUrgent: false, // New tasks are not urgent by default
                    isCompleted: false,
                    createdAt: serverTimestamp()
                });
                console.log("addTask: Document written with ID: ", docRef.id);
                statusMessage.textContent = "Task added successfully!";
                newTaskInput.value = '';
                taskDeadlineInput.value = ''; // Clear deadline input too
                taskCategoryInput.value = 'General'; // Reset category to default
            } catch (error) {
                console.error("addTask: Error adding document: ", error);
                statusMessage.textContent = "Failed to add task!";
                alert("Failed to add task. See console for details.");
            }
        }

        async function toggleComplete(taskItem) {
            if (!authReady || !taskItem.dataset.docId) return;

            const docRef = doc(db, `artifacts/${appId}/public/data/tasks`, taskItem.dataset.docId);
            const isCompleted = taskItem.dataset.completed === 'true';

            try {
                await updateDoc(docRef, {
                    isCompleted: !isCompleted,
                    isUrgent: false // When completed (or undone), remove from urgent
                });
                console.log("toggleComplete: Task status updated for ID:", taskItem.dataset.docId);
            } catch (error) {
                console.error("Error updating document: ", error);
                alert("Failed to update task status. See console for details.");
            }
        }

        async function toggleUrgent(taskItem) {
            if (!authReady || !taskItem.dataset.docId) return;

            const docRef = doc(db, `artifacts/${appId}/public/data/tasks`, taskItem.dataset.docId);
            const isUrgent = taskItem.dataset.urgent === 'true';

            try {
                await updateDoc(docRef, {
                    isUrgent: !isUrgent
                });
                console.log("toggleUrgent: Task urgent status updated for ID:", taskItem.dataset.docId);
            } catch (error) {
                console.error("Error updating document: ", error);
                alert("Failed to update task urgent status. See console for details.");
            }
        }

        async function deleteTask(taskItem) {
            if (!authReady || !taskItem.dataset.docId) return;

            const docRef = doc(db, `artifacts/${appId}/public/data/tasks`, taskItem.dataset.docId);

            try {
                await deleteDoc(docRef);
                console.log("deleteTask: Task deleted for ID:", taskItem.dataset.docId);
            } catch (error) {
                console.error("Error deleting document: ", error);
                alert("Failed to delete task. See console for details.");
            }
        }

        // Reinstated Functions for Notes Modal
        window.openNotesModal = function(taskItem) {
            currentTaskItemForNotes = taskItem;
            editNotesTextarea.value = taskItem.dataset.notes || '';
            notesModal.style.display = 'flex';
            console.log("openNotesModal: Opening notes for task ID:", taskItem.dataset.docId);
        }

        window.closeNotesModal = function() {
            notesModal.style.display = 'none';
            currentTaskItemForNotes = null;
            console.log("closeNotesModal: Notes modal closed.");
        }

        window.saveNotes = async function() {
            if (!authReady || !currentTaskItemForNotes || !currentTaskItemForNotes.dataset.docId) {
                console.warn("saveNotes: Authentication not ready or no task selected.");
                return;
            }

            const docRef = doc(db, `artifacts/${appId}/public/data/tasks`, currentTaskItemForNotes.dataset.docId);
            const newNotes = editNotesTextarea.value.trim();

            try {
                await updateDoc(docRef, {
                    notes: newNotes
                });
                console.log("saveNotes: Notes updated for ID:", currentTaskItemForNotes.dataset.docId);
            } catch (error) {
                console.error("saveNotes: Error saving notes: ", error);
                alert("Failed to save notes. See console for details.");
            } finally {
                closeNotesModal();
            }
        }

        // --- Export to CSV Function ---
        function exportTasksToCsv() {
            if (allTasksData.length === 0) {
                alert("No tasks to export!");
                return;
            }

            const headers = ["Task", "Deadline", "Category", "Notes", "Is Urgent", "Is Completed", "Created At"];
            let csv = headers.join(",") + "\n";

            allTasksData.forEach(task => {
                const row = [
                    `"${task.text.replace(/"/g, '""')}"`,
                    task.deadline || '',
                    task.category || 'General',
                    `"${task.notes ? task.notes.replace(/"/g, '""') : ''}"`,
                    task.isUrgent ? 'TRUE' : 'FALSE',
                    task.isCompleted ? 'TRUE' : 'FALSE',
                    task.createdAt ? new Date(task.createdAt.toDate()).toLocaleString() : ''
                ];
                csv += row.join(",") + "\n";
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "anand_tasks.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } else {
                alert("Your browser does not support downloading files directly. Please copy the data manually.");
            }
        }

        // --- Event Listeners ---
        addTaskBtn.addEventListener('click', addTask);
        exportTasksBtn.addEventListener('click', exportTasksToCsv);

        newTaskInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addTask();
            }
        });
        taskDeadlineInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addTask();
            }
        });
        taskCategoryInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addTask();
            }
        });

        window.addEventListener('click', (event) => {
            if (event.target === notesModal) {
                closeNotesModal();
            }
        });

        window.onload = initializeFirebase;
    </script>
</body>
</html>
