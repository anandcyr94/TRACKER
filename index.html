<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anand Tasks Board</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to right bottom, #e0f7fa, #c8e6c9);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
        }
        .task-item {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease-in-out;
        }
        .task-item.completed {
            background-color: #e0f2f7;
            text-decoration: line-through;
            color: #6b7280;
        }
        .task-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.06);
        }
        .task-content {
            flex-grow: 1;
            width: 100%;
            margin-bottom: 0.5rem;
            word-break: break-word;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .task-text {
            font-size: 1.125rem;
            color: #1f2937;
            line-height: 1.4;
        }
        .task-deadline {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        .task-notes {
            font-size: 0.875rem;
            color: #4b5563;
            margin-top: 0.5rem;
            background-color: #f9fafb;
            padding: 0.5rem;
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb;
            white-space: pre-wrap;
            width: 100%;
            box-sizing: border-box;
        }
        .task-category {
            font-size: 0.75rem;
            color: #4f46e5;
            background-color: #e0e7ff;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            margin-left: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
            align-self: flex-start;
        }
        .task-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            width: 100%;
            justify-content: flex-end;
            margin-top: 0.5rem;
        }
        .task-actions button {
            padding: 0.4rem 0.8rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
        }
        .task-actions button:hover {
            opacity: 0.9;
        }
        /* Category Header Styling */
        .category-header {
            font-size: 1.25rem;
            font-weight: 600;
            color: #4b5563;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            padding-left: 0.5rem;
            border-left: 4px solid;
            display: flex;
            align-items: center;
        }
        .daily-category-border {
            border-color: #60a5fa;
        }
        .pending-category-border {
            border-color: #f87171;
        }
        .completed-category-border {
            border-color: #34d399;
        }
        .all-category-border {
            border-color: #9ca3af;
        }
        /* Dashboard Section Backgrounds for distinction */
        #dailyTasksSection {
            background-color: #e3f2fd; /* Light Blue */
        }
        #pendingTasksSection {
            background-color: #ffebee; /* Light Red */
        }
        #completedTasksSection {
            background-color: #e8f5e9; /* Light Green */
        }
        #allTasksSection {
            background-color: #f5f5f5; /* Very Light Gray */
        }

        /* Ensure input fields take full width on small screens */
        .mb-8 > .flex-grow {
            width: 100%;
        }
        @media (min-width: 640px) {
            .mb-8 > .flex-grow {
                width: auto;
            }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-8">Anand Tasks Board</h1>

        <!-- User ID Display -->
        <div class="text-center text-sm text-gray-500 mb-2">
            User ID: <span id="userIdDisplay" class="font-mono text-gray-700">Loading...</span>
        </div>
        <!-- Status Message -->
        <div id="statusMessage" class="text-center text-sm text-blue-600 mb-4">
            Initializing app...
        </div>

        <!-- Task Input Section -->
        <div class="mb-8 flex flex-col sm:flex-row gap-4 flex-wrap">
            <input type="text" id="newTaskInput" placeholder="Add a new task..."
                   class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700">
            <input type="date" id="taskDeadlineInput"
                   class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700">
            <select id="taskCategoryInput"
                    class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700">
                <option value="General">General</option>
                <option value="AP-FT">AP-FT</option>
                <option value="REC">REC</option>
                <option value="Upwork">Upwork</option>
                <option value="Bambio">Bambio</option>
                <option value="Personal">Personal</option>
                <option value="Other">Other</option>
                <option value="PhD-Anand">PhD-Anand</option>
            </select>
            <button id="addTaskBtn"
                    class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 ease-in-out shadow-md">
                Add Task
            </button>
        </div>

        <!-- Export Button -->
        <div class="mb-8 text-center">
            <button id="exportTasksBtn"
                    class="bg-gray-700 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-700 focus:ring-offset-2 transition duration-200 ease-in-out shadow-md">
                Export All Tasks to CSV
            </button>
        </div>

        <!-- Task Dashboards -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Daily Tasks Section -->
            <div id="dailyTasksSection" class="p-6 rounded-lg shadow-inner">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center">
                    Daily Tasks (Today)
                    <!-- Modern Sun Icon -->
                    <svg class="ml-2 w-6 h-6 text-yellow-500" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.106a.75.75 0 00-1.06-1.06l-1.59 1.59a.75.75 0 101.06 1.06l1.59-1.59zM12 18a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V18a.75.75 0 01.75-.75zM5.656 17.344a.75.75 0 001.06-1.06l-1.59-1.59a.75.75 0 10-1.06 1.06l1.59 1.59zM3 12a.75.75 0 01.75-.75h2.25a.75.75 0 010 1.5H3.75A.75.75 0 013 12zM17.344 5.656a.75.75 0 00-1.06 1.06l1.59 1.59a.75.75 0 101.06-1.06l-1.59-1.59zM12 3a9 9 0 100 18 9 9 0 000-18z" />
                    </svg>
                </h2>
                <div id="dailyTasksList" class="space-y-3">
                    <!-- Daily tasks for today will be appended here -->
                </div>
                <p id="noDailyTasks" class="text-gray-500 text-center mt-4 hidden">No daily tasks for today!</p>
            </div>

            <!-- Pending Tasks Section -->
            <div id="pendingTasksSection" class="p-6 rounded-lg shadow-inner">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center">
                    Pending Tasks
                    <!-- Modern Flag Icon -->
                    <svg class="ml-2 w-6 h-6 text-red-500" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1v12zm0 0v2a2 2 0 002 2h3v-3H4z" />
                    </svg>
                </h2>
                <div id="pendingTasksList" class="space-y-3">
                    <!-- Pending tasks will be appended here -->
                </div>
                <p id="noPendingTasks" class="text-gray-500 text-center mt-4 hidden">No pending tasks yet!</p>
            </div>
        </div>

        <!-- Completed Tasks Section -->
        <div id="completedTasksSection" class="mt-8 p-6 rounded-lg shadow-inner">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center">
                Completed Tasks
                <!-- Modern Checkmark Circle Icon -->
                <svg class="ml-2 w-6 h-6 text-green-500" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm13.36-1.814a.75.75 0 10-1.22-.872l-3.236 4.532-1.267-1.267a.75.75 0 00-1.06 1.06l1.75 1.75a.75.75 0 001.135-.082l3.75-5.25z" clip-rule="evenodd" />
                </svg>
            </h2>
            <div id="completedTasksList" class="space-y-3">
                <!-- Completed tasks will be appended here -->
            </div>
            <p id="noCompletedTasks" class="text-gray-500 text-center mt-4 hidden">No completed tasks yet!</p>
        </div>

        <!-- All Tasks Section -->
        <div id="allTasksSection" class="mt-8 p-6 rounded-lg shadow-inner">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center">
                All Tasks
                <!-- Modern List Icon -->
                <svg class="ml-2 w-6 h-6 text-blue-500" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M3 5a1 1 0 011-1h16a1 1 0 110 2H4a1 1 0 01-1-1zm0 6a1 1 0 011-1h16a1 1 0 110 2H4a1 1 0 01-1-1zm0 6a1 1 0 011-1h16a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
                </svg>
            </h2>
            <div id="allTasksList" class="space-y-3">
                <!-- All tasks will be appended here -->
            </div>
            <p id="noAllTasks" class="text-gray-500 text-center mt-4 hidden">No tasks added yet!</p>
        </div>
    </div>

    <!-- Notes Edit Modal -->
    <div id="notesModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="window.closeNotesModal()">&times;</span>
            <h3 class="text-2xl font-semibold text-gray-800 mb-4">Edit Notes</h3>
            <textarea id="editNotesTextarea" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700 resize-y h-40 mb-4"></textarea>
            <button onclick="window.saveNotes()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 ease-in-out shadow-md">
                Save Notes
            </button>
        </div>
    </div>

    <script type="module">
        // Firebase SDK Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, onSnapshot, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables (provided by the Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // User-provided Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDNGaeo3jNhp5EImaZMBPEalq2ZvLw8XxQ",
            authDomain: "task-tracker-f77f1.firebaseapp.com",
            projectId: "task-tracker-f77f1",
            storageBucket: "task-tracker-f77f1.firebasestorage.app",
            messagingSenderId: "1096145801568",
            appId: "1:1096145801568:web:7f35bab25471a555434e05", // Your specific Firebase App ID
            measurementId: "G-4T4829KXPH"
        };

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let currentUserId = null;
        let authReady = false;
        let allTasksData = []; // Store all tasks for export

        // Get references to DOM elements
        const newTaskInput = document.getElementById('newTaskInput');
        const taskDeadlineInput = document.getElementById('taskDeadlineInput');
        const taskCategoryInput = document.getElementById('taskCategoryInput');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const exportTasksBtn = document.getElementById('exportTasksBtn');
        const dailyTasksList = document.getElementById('dailyTasksList');
        const pendingTasksList = document.getElementById('pendingTasksList');
        const completedTasksList = document.getElementById('completedTasksList');
        const allTasksList = document.getElementById('allTasksList');
        const noDailyTasksMessage = document.getElementById('noDailyTasks');
        const noPendingTasksMessage = document.getElementById('noPendingTasks');
        const noCompletedTasksMessage = document.getElementById('noCompletedTasks');
        const noAllTasksMessage = document.getElementById('noAllTasks');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const statusMessage = document.getElementById('statusMessage');

        const notesModal = document.getElementById('notesModal');
        const editNotesTextarea = document.getElementById('editNotesTextarea');
        let currentTaskItemForNotes = null;

        // --- Firebase Initialization and Authentication ---
        async function initializeFirebase() {
            console.log("Attempting to initialize Firebase.");
            console.log("App ID from environment (if available):", appId); 
            console.log("Firebase Config (used):", firebaseConfig); 
            console.log("Initial Auth Token present (if available):", !!initialAuthToken);

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase app, db, auth initialized.");
                statusMessage.textContent = "Authenticating...";

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userIdDisplay.textContent = currentUserId;
                        authReady = true;
                        console.log("onAuthStateChanged: User authenticated. UID:", currentUserId);
                        statusMessage.textContent = "App ready! User: " + currentUserId.substring(0, 8) + "...";
                        listenForTasks();
                    } else {
                        console.log("onAuthStateChanged: No user detected. Attempting anonymous sign-in.");
                        statusMessage.textContent = "Authenticating anonymously...";
                        try {
                            await signInAnonymously(auth);
                            console.log("onAuthStateChanged: Anonymous sign-in attempt completed.");
                        } catch (authError) {
                            console.error("onAuthStateChanged: Authentication error:", authError);
                            statusMessage.textContent = "Authentication failed!";
                            userIdDisplay.textContent = "Auth Error";
                        }
                    }
                });

            } catch (error) {
                console.error("Error during Firebase initialization or auth setup:", error);
                userIdDisplay.textContent = "Init Error";
                statusMessage.textContent = "Initialization failed!";
            }
        }

        // --- Firestore Real-time Listener ---
        function listenForTasks() {
            if (!db || !currentUserId) {
                console.warn("Firestore or User ID not ready for listening. Cannot set up snapshot listener.");
                return;
            }

            const tasksCollectionRef = collection(db, `artifacts/${appId}/public/data/tasks`);
            console.log("Setting up Firestore real-time listener for public path:", `artifacts/${appId}/public/data/tasks`);

            onSnapshot(tasksCollectionRef, (snapshot) => {
                console.log("Firestore snapshot received. Number of documents:", snapshot.size);
                dailyTasksList.innerHTML = '';
                pendingTasksList.innerHTML = '';
                completedTasksList.innerHTML = '';
                allTasksList.innerHTML = '';

                const tasks = [];
                snapshot.forEach(doc => {
                    tasks.push({ id: doc.id, ...doc.data() });
                });

                allTasksData = tasks; 

                tasks.sort((a, b) => {
                    const dateA = a.deadline ? new Date(a.deadline + 'T00:00:00') : new Date('9999-12-31T00:00:00');
                    const dateB = b.deadline ? new Date(b.deadline + 'T00:00:00') : new Date('9999-12-31T00:00:00');

                    if (dateA < dateB) return -1;
                    if (dateA > dateB) return 1;

                    const createdAtA = a.createdAt ? a.createdAt.toDate() : new Date(0);
                    const createdAtB = b.createdAt ? b.createdAt.toDate() : new Date(0);
                    if (createdAtA < createdAtB) return -1;
                    if (createdAtA > createdAtB) return 1;

                    return 0;
                });

                const today = new Date();
                const todayFormatted = today.toISOString().split('T')[0];

                const dailyTasksForTodayByCategory = {};
                const pendingTasksByCategory = {};
                const completedTasksByCategory = {};
                const allTasksByCategory = {};

                tasks.forEach(taskData => {
                    const category = taskData.category || 'General';

                    if (taskData.isDaily && taskData.deadline === todayFormatted && !taskData.isCompleted) {
                        if (!dailyTasksForTodayByCategory[category]) {
                            dailyTasksForTodayByCategory[category] = [];
                        }
                        dailyTasksForTodayByCategory[category].push(taskData);
                    }
                    
                    if (!taskData.isDaily && !taskData.isCompleted) {
                        if (!pendingTasksByCategory[category]) {
                            pendingTasksByCategory[category] = [];
                        }
                        pendingTasksByCategory[category].push(taskData);
                    }

                    if (taskData.isCompleted) {
                        if (!completedTasksByCategory[category]) {
                            completedTasksByCategory[category] = [];
                        }
                        completedTasksByCategory[category].push(taskData);
                    }

                    if (!allTasksByCategory[category]) {
                        allTasksByCategory[category] = [];
                    }
                    allTasksByCategory[category].push(taskData);
                });

                const sortedDailyCategories = Object.keys(dailyTasksForTodayByCategory).sort();
                sortedDailyCategories.forEach(category => {
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.classList.add('category-header', 'daily-category-border');
                    categoryHeader.textContent = category;
                    dailyTasksList.appendChild(categoryHeader);

                    dailyTasksForTodayByCategory[category].forEach(taskData => {
                        const taskItem = createTaskElement(
                            taskData.text,
                            taskData.deadline,
                            taskData.notes,
                            taskData.category,
                            taskData.isDaily,
                            taskData.isCompleted,
                            taskData.id
                        );
                        dailyTasksList.appendChild(taskItem);
                    });
                });

                const sortedPendingCategories = Object.keys(pendingTasksByCategory).sort();
                sortedPendingCategories.forEach(category => {
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.classList.add('category-header', 'pending-category-border');
                    categoryHeader.textContent = category;
                    pendingTasksList.appendChild(categoryHeader);

                    pendingTasksByCategory[category].forEach(taskData => {
                        const taskItem = createTaskElement(
                            taskData.text,
                            taskData.deadline,
                            taskData.notes,
                            taskData.category,
                            taskData.isDaily,
                            taskData.isCompleted,
                            taskData.id
                        );
                        pendingTasksList.appendChild(taskItem);
                    });
                });

                const sortedCompletedCategories = Object.keys(completedTasksByCategory).sort();
                sortedCompletedCategories.forEach(category => {
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.classList.add('category-header', 'completed-category-border');
                    categoryHeader.textContent = category;
                    completedTasksList.appendChild(categoryHeader);

                    completedTasksByCategory[category].forEach(taskData => {
                        const taskItem = createTaskElement(
                            taskData.text,
                            taskData.deadline,
                            taskData.notes,
                            taskData.category,
                            taskData.isDaily,
                            taskData.isCompleted,
                            taskData.id
                        );
                        completedTasksList.appendChild(taskItem);
                    });
                });

                const sortedAllCategories = Object.keys(allTasksByCategory).sort();
                sortedAllCategories.forEach(category => {
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.classList.add('category-header', 'all-category-border');
                    categoryHeader.textContent = category;
                    allTasksList.appendChild(categoryHeader);

                    allTasksByCategory[category].forEach(taskData => {
                        const taskItem = createTaskElement( // Fixed typo: createTaskC to createTaskElement
                            taskData.text,
                            taskData.deadline,
                            taskData.notes,
                            taskData.category,
                            taskData.isDaily,
                            taskData.isCompleted,
                            taskData.id
                        );
                        allTasksList.appendChild(taskItem);
                    });
                });

                updateNoTasksMessages();
                console.log("UI updated with tasks.");
            }, (error) => {
                console.error("Error listening to tasks:", error);
                if (error.code === 'permission-denied' || error.message.includes('Missing or insufficient permissions')) {
                    statusMessage.textContent = "Error: Permission denied! Check Firestore Rules.";
                    console.error("Firestore Permission Error: Please ensure your Firestore Security Rules allow read/write access for authenticated users to the public task collection.");
                    console.error("Example Rule: allow read, write: if request.auth != null;");
                } else {
                    statusMessage.textContent = "Error loading tasks!";
                }
            });
        }

        // --- UI Update Functions ---
        function updateNoTasksMessages() {
            noDailyTasksMessage.classList.toggle('hidden', dailyTasksList.children.length > 0);
            noPendingTasksMessage.classList.toggle('hidden', pendingTasksList.children.length > 0);
            noCompletedTasksMessage.classList.toggle('hidden', completedTasksList.children.length > 0);
            noAllTasksMessage.classList.toggle('hidden', allTasksList.children.length > 0);
        }

        // Function to create a new task element (UI only)
        function createTaskElement(taskText, deadline = '', notes = '', category = 'General', isDaily = false, isCompleted = false, docId = null) {
            const taskItem = document.createElement('div');
            taskItem.classList.add('task-item');
            if (isCompleted) {
                taskItem.classList.add('completed');
            }
            taskItem.dataset.daily = isDaily;
            taskItem.dataset.completed = isCompleted;
            taskItem.dataset.deadline = deadline;
            taskItem.dataset.notes = notes;
            taskItem.dataset.category = category;
            taskItem.dataset.docId = docId;

            const taskContentDiv = document.createElement('div');
            taskContentDiv.classList.add('task-content');

            const taskSpan = document.createElement('span');
            taskSpan.classList.add('task-text', 'block');
            taskSpan.textContent = taskText;
            taskContentDiv.appendChild(taskSpan);

            if (deadline) {
                const deadlineSpan = document.createElement('span');
                deadlineSpan.classList.add('task-deadline', 'block');
                const date = new Date(deadline + 'T00:00:00');
                deadlineSpan.textContent = `Due: ${date.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' })}`;
                taskContentDiv.appendChild(deadlineSpan);
            }

            if (category && category !== 'General') {
                const categorySpan = document.createElement('span');
                categorySpan.classList.add('task-category');
                categorySpan.textContent = category;
                taskContentDiv.appendChild(categorySpan);
            }

            // Reinstated notes display
            const notesDisplayDiv = document.createElement('div');
            notesDisplayDiv.classList.add('task-notes', 'hidden');
            if (notes) {
                notesDisplayDiv.textContent = notes;
                notesDisplayDiv.classList.remove('hidden');
            }
            taskContentDiv.appendChild(notesDisplayDiv);

            taskItem.appendChild(taskContentDiv);

            const actionsDiv = document.createElement('div');
            actionsDiv.classList.add('task-actions', 'flex-shrink-0');

            const completeBtn = document.createElement('button');
            completeBtn.textContent = isCompleted ? 'Undo' : 'Complete';
            completeBtn.classList.add(
                isCompleted ? 'bg-yellow-500' : 'bg-green-500',
                'text-white',
                'hover:bg-green-600',
                'hover:bg-yellow-600',
                'focus:outline-none',
                'focus:ring-2',
                'focus:ring-offset-2',
                'focus:ring-green-500'
            );
            completeBtn.onclick = () => toggleComplete(taskItem);
            actionsDiv.appendChild(completeBtn);

            const moveBtn = document.createElement('button');
            moveBtn.textContent = isDaily ? 'Move to Pending' : 'Move to Daily';
            moveBtn.classList.add(
                isDaily ? 'bg-purple-500' : 'bg-indigo-500',
                'text-white',
                'hover:bg-purple-600',
                'hover:bg-indigo-600',
                'focus:outline-none',
                'focus:ring-2',
                'focus:ring-offset-2',
                'focus:ring-purple-500'
            );
            moveBtn.onclick = () => moveTask(taskItem);
            actionsDiv.appendChild(moveBtn);

            // Reinstated Edit Notes Button
            const editNotesBtn = document.createElement('button');
            editNotesBtn.textContent = 'Edit Notes';
            editNotesBtn.classList.add(
                'bg-gray-500',
                'text-white',
                'hover:bg-gray-600',
                'focus:outline-none',
                'focus:ring-2',
                'focus:ring-offset-2',
                'focus:ring-gray-500'
            );
            editNotesBtn.onclick = () => openNotesModal(taskItem);
            actionsDiv.appendChild(editNotesBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            deleteBtn.classList.add(
                'bg-red-500',
                'text-white',
                'hover:bg-red-600',
                'focus:outline-none',
                'focus:ring-2',
                'focus:ring-offset-2',
                'focus:ring-red-500'
            );
            deleteBtn.onclick = () => deleteTask(taskItem);
            actionsDiv.appendChild(deleteBtn);

            taskItem.appendChild(actionsDiv);
            return taskItem;
        }

        // --- Firestore Data Operations ---

        async function addTask() {
            console.log("Attempting to add task...");
            if (!authReady) {
                console.error("addTask: Authentication not ready. Cannot add task.");
                statusMessage.textContent = "App not ready. Please wait.";
                alert("Please wait for the app to initialize.");
                return;
            }
            console.log("addTask: Auth is ready. currentUserId:", currentUserId);

            const taskText = newTaskInput.value.trim();
            const taskDeadline = taskDeadlineInput.value;
            const taskCategory = taskCategoryInput.value;
            const taskNotes = ''; 

            if (taskText === '') {
                alert('Please enter a task!');
                return;
            }

            try {
                const tasksCollectionRef = collection(db, `artifacts/${appId}/public/data/tasks`);
                const docRef = await addDoc(tasksCollectionRef, {
                    text: taskText,
                    deadline: taskDeadline,
                    notes: taskNotes,
                    category: taskCategory,
                    isDaily: true,
                    isCompleted: false,
                    createdAt: serverTimestamp()
                });
                console.log("addTask: Document written with ID: ", docRef.id);
                statusMessage.textContent = "Task added successfully!";
                newTaskInput.value = '';
                taskDeadlineInput.value = '';
                taskCategoryInput.value = 'General';
            } catch (error) {
                console.error("addTask: Error adding document: ", error);
                statusMessage.textContent = "Failed to add task!";
                alert("Failed to add task. See console for details.");
            }
        }

        async function toggleComplete(taskItem) {
            if (!authReady || !taskItem.dataset.docId) return;

            const docRef = doc(db, `artifacts/${appId}/public/data/tasks`, taskItem.dataset.docId);
            const isCompleted = taskItem.dataset.completed === 'true';

            try {
                await updateDoc(docRef, {
                    isCompleted: !isCompleted
                });
                console.log("toggleComplete: Task status updated for ID:", taskItem.dataset.docId);
            } catch (error) {
                console.error("Error updating document: ", error);
                alert("Failed to update task status. See console for details.");
            }
        }

        async function moveTask(taskItem) {
            if (!authReady || !taskItem.dataset.docId) return;

            const docRef = doc(db, `artifacts/${appId}/public/data/tasks`, taskItem.dataset.docId);
            const isDaily = taskItem.dataset.daily === 'true';

            try {
                await updateDoc(docRef, {
                    isDaily: !isDaily
                });
                console.log("moveTask: Task category updated for ID:", taskItem.dataset.docId);
            } catch (error) {
                console.error("Error moving document: ", error);
                alert("Failed to move task. See console for details.");
            }
        }

        async function deleteTask(taskItem) {
            if (!authReady || !taskItem.dataset.docId) return;

            const docRef = doc(db, `artifacts/${appId}/public/data/tasks`, taskItem.dataset.docId);

            try {
                await deleteDoc(docRef);
                console.log("deleteTask: Task deleted for ID:", taskItem.dataset.docId);
            } catch (error) {
                console.error("Error deleting document: ", error);
                alert("Failed to delete task. See console for details.");
            }
        }

        // Reinstated Functions for Notes Modal
        window.openNotesModal = function(taskItem) {
            currentTaskItemForNotes = taskItem;
            editNotesTextarea.value = taskItem.dataset.notes || '';
            notesModal.style.display = 'flex';
            console.log("openNotesModal: Opening notes for task ID:", taskItem.dataset.docId);
        }

        window.closeNotesModal = function() {
            notesModal.style.display = 'none';
            currentTaskItemForNotes = null;
            console.log("closeNotesModal: Notes modal closed.");
        }

        window.saveNotes = async function() {
            if (!authReady || !currentTaskItemForNotes || !currentTaskItemForNotes.dataset.docId) {
                console.warn("saveNotes: Authentication not ready or no task selected.");
                return;
            }

            const docRef = doc(db, `artifacts/${appId}/public/data/tasks`, currentTaskItemForNotes.dataset.docId);
            const newNotes = editNotesTextarea.value.trim();

            try {
                await updateDoc(docRef, {
                    notes: newNotes
                });
                console.log("saveNotes: Notes updated for ID:", currentTaskItemForNotes.dataset.docId);
            }  catch (error) {
                console.error("saveNotes: Error saving notes: ", error);
                alert("Failed to save notes. See console for details.");
            } finally {
                closeNotesModal();
            }
        }

        // --- Export to CSV Function ---
        function exportTasksToCsv() {
            if (allTasksData.length === 0) {
                alert("No tasks to export!");
                return;
            }

            const headers = ["Task", "Deadline", "Category", "Notes", "Is Daily", "Is Completed", "Created At"];
            let csv = headers.join(",") + "\n";

            allTasksData.forEach(task => {
                const row = [
                    `"${task.text.replace(/"/g, '""')}"`,
                    task.deadline || '',
                    task.category || 'General',
                    `"${task.notes ? task.notes.replace(/"/g, '""') : ''}"`,
                    task.isDaily ? 'TRUE' : 'FALSE',
                    task.isCompleted ? 'TRUE' : 'FALSE',
                    task.createdAt ? new Date(task.createdAt.toDate()).toLocaleString() : ''
                ];
                csv += row.join(",") + "\n";
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "tasks.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } else {
                alert("Your browser does not support downloading files directly. Please copy the data manually.");
            }
        }

        // --- Event Listeners ---
        addTaskBtn.addEventListener('click', addTask);
        exportTasksBtn.addEventListener('click', exportTasksToCsv);

        newTaskInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addTask();
            }
        });
        taskDeadlineInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addTask();
            }
        });
        taskCategoryInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addTask();
            }
        });

        // Reinstated event listener for the notes modal
        window.addEventListener('click', (event) => {
            if (event.target === notesModal) {
                closeNotesModal();
            }
        });

        window.onload = initializeFirebase;
    </script>
</body>
</html>
