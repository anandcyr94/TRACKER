<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anand Tasks Board</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to right bottom, #e0f7fa, #c8e6c9);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .main-container {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 1200px;
            margin: auto;
        }
        
        /* New Kanban-style layout */
        .board-columns {
            display: flex;
            gap: 1.25rem; /* 20px */
            flex-wrap: wrap;
        }
        .column {
            flex: 1;
            min-width: 250px;
            background-color: #e8ebf0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding-bottom: 0.9375rem; /* 15px */
        }
        .column-header {
            text-align: center;
            color: #fff;
            padding: 0.9375rem 0.625rem; /* 15px 10px */
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
        }
        .daily-header {
            background-color: #60a5fa; /* blue-400 */
        }
        .pending-header {
            background-color: #f87171; /* red-400 */
        }
        .completed-header {
            background-color: #34d399; /* green-500 */
        }
        .all-header {
            background-color: #9ca3af; /* gray-400 */
        }
        .urgent-header {
            background-color: #ef4444; /* Red for urgent */
        }
        
        .task-item {
            background-color: #ffffff;
            border-radius: 0.375rem; /* 6px */
            padding: 0.9375rem; /* 15px */
            margin-bottom: 0.625rem; /* 10px */
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
        }
        .task-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .task-content {
            flex-grow: 1;
            width: 100%;
            margin-bottom: 0.5rem;
            word-break: break-word;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .task-text {
            font-size: 1.125rem;
            color: #1f2937;
            line-height: 1.4;
            margin: 0;
            margin-bottom: 0.3125rem; /* 5px */
        }
        .task-deadline {
            font-size: 0.875rem;
            color: #666;
            margin: 0;
            margin-bottom: 0.625rem; /* 10px */
            cursor: pointer; /* Indicate it's clickable */
        }
        .task-notes {
            font-size: 0.875rem;
            color: #4b5563;
            margin-top: 0.5rem;
            background-color: #f9fafb;
            padding: 0.5rem;
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb;
            white-space: pre-wrap;
            width: 100%;
            box-sizing: border-box;
        }
        .task-category {
            display: inline-block;
            padding: 4px 8px;
            font-size: 0.8em;
            font-weight: bold;
            border-radius: 4px;
            color: #fff;
            background-color: #7f8c8d;
        }
        .task-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            width: 100%;
            justify-content: flex-end;
            margin-top: 0.5rem;
        }
        .task-actions button {
            padding: 0.4rem 0.8rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
        }
        .task-actions button:hover {
            opacity: 0.9;
        }
        
        .category-header {
            font-size: 1.25rem;
            font-weight: 600;
            color: #4b5563;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            padding-left: 0.5rem;
            border-left: 4px solid;
            display: flex;
            align-items: center;
        }
        .daily-category-border { border-color: #60a5fa; }
        .pending-category-border { border-color: #f87171; }
        .completed-category-border { border-color: #34d399; }
        .all-category-border { border-color: #9ca3af; }
        .urgent-category-border { border-color: #ef4444; }

        .dashboard-container {
            display: flex;
            gap: 1.5rem;
        }
        .dashboards-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }
        .urgent-dashboard {
            width: 25%;
            min-width: 250px;
            background-color: #fee2e2; /* Light red */
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1rem;
        }
        @media (max-width: 1024px) {
            .dashboard-container {
                flex-direction: column;
            }
            .urgent-dashboard {
                width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            .board-columns {
                flex-direction: column;
            }
        }
        @media (min-width: 640px) {
            .input-section-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .input-section-grid button {
                grid-column: span 3;
            }
        }
        @media (min-width: 768px) {
            .input-section-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            .input-section-grid button {
                grid-column: span 1;
            }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="main-container">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-8">Anand Tasks Board</h1>

        <div class="text-center text-sm text-gray-500 mb-2">
            User ID: <span id="userIdDisplay" class="font-mono text-gray-700">Loading...</span>
        </div>
        <div id="statusMessage" class="text-center text-sm text-blue-600 mb-4">
            Initializing app...
        </div>

        <div class="mb-8 input-section-grid">
            <input type="text" id="newTaskInput" placeholder="Add a new task..."
                   class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700 col-span-full md:col-span-1">
            <input type="date" id="taskDeadlineInput"
                   class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700 col-span-full md:col-span-1">
            <select id="taskCategoryInput"
                    class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700 col-span-full md:col-span-1">
                <option value="General">General</option>
                <option value="AP-FT">AP-FT</option>
                <option value="REC">REC</option>
                <option value="Upwork">Upwork</option>
                <option value="Bambio">Bambio</option>
                <option value="Personal">Personal</option>
                <option value="Other">Other</option>
                <option value="PhD-Anand">PhD-Anand</option>
            </select>
            <button id="addTaskBtn"
                    class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 ease-in-out shadow-md col-span-full md:col-span-1">
                Add Task
            </button>
        </div>

        <div class="mb-8 text-center">
            <button id="exportTasksBtn"
                    class="bg-gray-700 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-700 focus:ring-offset-2 transition duration-200 ease-in-out shadow-md">
                Export All Tasks to CSV
            </button>
        </div>

        <div class="dashboard-container">
            <div class="dashboards-grid">
                <div id="dailyTasksSection" class="column">
                    <div class="column-header daily-header">
                        Daily Tasks (Today)
                    </div>
                    <div id="dailyTasksList" class="card-list">
                    </div>
                    <p id="noDailyTasks" class="text-gray-500 text-center mt-4 hidden">No daily tasks for today!</p>
                </div>
                
                <div id="pendingTasksSection" class="column">
                    <div class="column-header pending-header">
                        Pending Tasks
                    </div>
                    <div id="pendingTasksList" class="card-list">
                    </div>
                    <p id="noPendingTasks" class="text-gray-500 text-center mt-4 hidden">No pending tasks yet!</p>
                </div>
            </div>
            
            <div id="urgentTasksSection" class="column urgent-dashboard">
                <div class="column-header urgent-header">
                    Urgent Tasks
                </div>
                <div id="urgentTasksList" class="card-list">
                </div>
                <p id="noUrgentTasks" class="text-gray-500 text-center mt-4 hidden">No urgent tasks!</p>
            </div>
        </div>

        <div id="allTasksSection" class="mt-8 p-6 rounded-lg shadow-inner">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center">
                All Tasks
                <svg class="ml-2 w-6 h-6 text-blue-500" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M3 5a1 1 0 011-1h16a1 1 0 110 2H4a1 1 0 01-1-1zm0 6a1 1 0 011-1h16a1 1 0 110 2H4a1 1 0 01-1-1zm0 6a1 1 0 011-1h16a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
                </svg>
            </h2>
            <div id="allTasksList" class="space-y-3">
            </div>
            <p id="noAllTasks" class="text-gray-500 text-center mt-4 hidden">No tasks added yet!</p>
        </div>

        <div id="completedTasksSection" class="mt-8 p-6 rounded-lg shadow-inner">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center">
                Completed Tasks
                <svg class="ml-2 w-6 h-6 text-green-500" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm13.36-1.814a.75.75 0 10-1.22-.872l-3.236 4.532-1.267-1.267a.75.75 0 00-1.06 1.06l1.75 1.75a.75.75 0 001.135-.082l3.75-5.25z" clip-rule="evenodd" />
                </svg>
            </h2>
            <div id="completedTasksList" class="space-y-3">
            </div>
            <p id="noCompletedTasks" class="text-gray-500 text-center mt-4 hidden">No completed tasks yet!</p>
        </div>
    </div>

    <div id="notesModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="window.closeNotesModal()">&times;</span>
            <h3 class="text-2xl font-semibold text-gray-800 mb-4">Edit Notes</h3>
            <textarea id="editNotesTextarea" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700 resize-y h-40 mb-4"></textarea>
            <button onclick="window.saveNotes()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 ease-in-out shadow-md">
                Save Notes
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, onSnapshot, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        const firebaseConfig = {
            apiKey: "AIzaSyDNGaeo3jNhp5EImaZMBPEalq2ZvLw8XxQ",
            authDomain: "task-tracker-f77f1.firebaseapp.com",
            projectId: "task-tracker-f77f1",
            storageBucket: "task-tracker-f77f1.firebasestorage.app",
            messagingSenderId: "1096145801568",
            appId: "1:1096145801568:web:7f35bab25471a555434e05",
            measurementId: "G-4T4829KXPH"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let currentUserId = null;
        let authReady = false;
        let allTasksData = [];
        let currentTaskItemForNotes = null;


        function getFormattedDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                document.getElementById('statusMessage').textContent = "Authenticating...";

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        document.getElementById('userIdDisplay').textContent = currentUserId;
                        authReady = true;
                        document.getElementById('statusMessage').textContent = "App ready! User: " + currentUserId.substring(0, 8) + "...";
                        listenForTasks();
                    } else {
                        document.getElementById('statusMessage').textContent = "Authenticating anonymously...";
                        try {
                            await signInAnonymously(auth);
                        } catch (authError) {
                            console.error("onAuthStateChanged: Authentication error:", authError);
                            document.getElementById('statusMessage').textContent = "Authentication failed!";
                            document.getElementById('userIdDisplay').textContent = "Auth Error";
                        }
                    }
                });
            } catch (error) {
                console.error("Error during Firebase initialization or auth setup:", error);
                document.getElementById('userIdDisplay').textContent = "Init Error";
                document.getElementById('statusMessage').textContent = "Initialization failed!";
            }
        }

        function listenForTasks() {
            if (!db || !currentUserId) {
                console.warn("Firestore or User ID not ready for listening. Cannot set up snapshot listener.");
                return;
            }

            const tasksCollectionRef = collection(db, `artifacts/${appId}/public/data/tasks`);

            onSnapshot(tasksCollectionRef, async (snapshot) => {
                const dailyTasksList = document.getElementById('dailyTasksList');
                const pendingTasksList = document.getElementById('pendingTasksList');
                const completedTasksList = document.getElementById('completedTasksList');
                const allTasksList = document.getElementById('allTasksList');
                const urgentTasksList = document.getElementById('urgentTasksList');

                dailyTasksList.innerHTML = '';
                pendingTasksList.innerHTML = '';
                completedTasksList.innerHTML = '';
                allTasksList.innerHTML = '';
                urgentTasksList.innerHTML = '';

                const tasks = [];
                snapshot.forEach(doc => {
                    tasks.push({ id: doc.id, ...doc.data() });
                });

                allTasksData = tasks;

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayFormatted = getFormattedDate(today);

                for (const task of tasks) {
                    if (task.isDaily && !task.isCompleted && task.deadline) {
                        const taskDeadlineDate = new Date(task.deadline + 'T00:00:00');
                        if (taskDeadlineDate < today) {
                            const docRef = doc(db, `artifacts/${appId}/public/data/tasks`, task.id);
                            try {
                                await updateDoc(docRef, { isDaily: false });
                            } catch (error) {
                                console.error("Error auto-moving task:", error);
                            }
                        }
                    }
                }
                
                tasks.sort((a, b) => {
                    const dateA = a.deadline ? new Date(a.deadline + 'T00:00:00') : new Date('9999-12-31T00:00:00');
                    const dateB = b.deadline ? new Date(b.deadline + 'T00:00:00') : new Date('9999-12-31T00:00:00');

                    if (dateA < dateB) return -1;
                    if (dateA > dateB) return 1;

                    const createdAtA = a.createdAt ? a.createdAt.toDate() : new Date(0);
                    const createdAtB = b.createdAt ? b.createdAt.toDate() : new Date(0);
                    if (createdAtA < createdAtB) return -1;
                    if (createdAtA > createdAtB) return 1;

                    return 0;
                });

                const dailyTasksForTodayByCategory = {};
                const pendingTasksByCategory = {};
                const completedTasksByCategory = {};
                const urgentTasksByCategory = {}; // New: Urgent tasks by category
                const allTasksNotCompletedByCategory = {};

                tasks.forEach(taskData => {
                    const category = taskData.category || 'General';

                    if (taskData.isDaily && taskData.deadline === todayFormatted && !taskData.isCompleted) {
                        if (!dailyTasksForTodayByCategory[category]) {
                            dailyTasksForTodayByCategory[category] = [];
                        }
                        dailyTasksForTodayByCategory[category].push(taskData);
                    }
                    
                    if (!taskData.isDaily && !taskData.isCompleted && !taskData.isUrgent) {
                        if (!pendingTasksByCategory[category]) {
                            pendingTasksByCategory[category] = [];
                        }
                        pendingTasksByCategory[category].push(taskData);
                    }

                    if (taskData.isUrgent && !taskData.isCompleted) {
                        if (!urgentTasksByCategory[category]) {
                            urgentTasksByCategory[category] = [];
                        }
                        urgentTasksByCategory[category].push(taskData);
                    }

                    if (taskData.isCompleted) {
                        if (!completedTasksByCategory[category]) {
                            completedTasksByCategory[category] = [];
                        }
                        completedTasksByCategory[category].push(taskData);
                    }

                    if (!taskData.isCompleted) {
                        if (!allTasksNotCompletedByCategory[category]) {
                            allTasksNotCompletedByCategory[category] = [];
                        }
                        allTasksNotCompletedByCategory[category].push(taskData);
                    }
                });

                const sortedDailyCategories = Object.keys(dailyTasksForTodayByCategory).sort();
                sortedDailyCategories.forEach(category => {
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.classList.add('category-header', 'daily-category-border');
                    categoryHeader.textContent = category;
                    dailyTasksList.appendChild(categoryHeader);

                    dailyTasksForTodayByCategory[category].forEach(taskData => {
                        const taskItem = createTaskElement(taskData);
                        dailyTasksList.appendChild(taskItem);
                    });
                });

                const sortedPendingCategories = Object.keys(pendingTasksByCategory).sort();
                sortedPendingCategories.forEach(category => {
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.classList.add('category-header', 'pending-category-border');
                    categoryHeader.textContent = category;
                    pendingTasksList.appendChild(categoryHeader);

                    pendingTasksByCategory[category].forEach(taskData => {
                        const taskItem = createTaskElement(taskData);
                        pendingTasksList.appendChild(taskItem);
                    });
                });

                const sortedUrgentCategories = Object.keys(urgentTasksByCategory).sort();
                sortedUrgentCategories.forEach(category => {
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.classList.add('category-header', 'urgent-category-border');
                    categoryHeader.textContent = category;
                    urgentTasksList.appendChild(categoryHeader);
                    urgentTasksByCategory[category].forEach(taskData => {
                        const taskItem = createTaskElement(taskData);
                        urgentTasksList.appendChild(taskItem);
                    });
                });

                const sortedAllCategories = Object.keys(allTasksNotCompletedByCategory).sort();
                sortedAllCategories.forEach(category => {
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.classList.add('category-header', 'all-category-border');
                    categoryHeader.textContent = category;
                    allTasksList.appendChild(categoryHeader);

                    allTasksNotCompletedByCategory[category].forEach(taskData => {
                        const taskItem = createTaskElement(taskData);
                        allTasksList.appendChild(taskItem);
                    });
                });
                
                const sortedCompletedCategories = Object.keys(completedTasksByCategory).sort();
                sortedCompletedCategories.forEach(category => {
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.classList.add('category-header', 'completed-category-border');
                    categoryHeader.textContent = category;
                    completedTasksList.appendChild(categoryHeader);

                    completedTasksByCategory[category].forEach(taskData => {
                        const taskItem = createTaskElement(taskData);
                        completedTasksList.appendChild(taskItem);
                    });
                });

                updateNoTasksMessages();
            }, (error) => {
                console.error("Error listening to tasks:", error);
                if (error.code === 'permission-denied' || error.message.includes('Missing or insufficient permissions')) {
                    document.getElementById('statusMessage').textContent = "Error: Permission denied! Check Firestore Rules.";
                    console.error("Firestore Permission Error: Please ensure your Firestore Security Rules allow read/write access for authenticated users to the public task collection.");
                    console.error("Example Rule: allow read, write: if request.auth != null;");
                } else {
                    document.getElementById('statusMessage').textContent = "Error loading tasks!";
                }
            });
        }

        function updateNoTasksMessages() {
            const noDailyTasksMessage = document.getElementById('noDailyTasks');
            const noPendingTasksMessage = document.getElementById('noPendingTasks');
            const noCompletedTasksMessage = document.getElementById('noCompletedTasks');
            const noAllTasksMessage = document.getElementById('noAllTasks');
            const noUrgentTasksMessage = document.getElementById('noUrgentTasks');
            
            noDailyTasksMessage.classList.toggle('hidden', document.getElementById('dailyTasksList').children.length > 0);
            noPendingTasksMessage.classList.toggle('hidden', document.getElementById('pendingTasksList').children.length > 0);
            noCompletedTasksMessage.classList.toggle('hidden', document.getElementById('completedTasksList').children.length > 0);
            noAllTasksMessage.classList.toggle('hidden', document.getElementById('allTasksList').children.length > 0);
            noUrgentTasksMessage.classList.toggle('hidden', document.getElementById('urgentTasksList').children.length > 0);
        }

        function createTaskElement(taskData) {
            const { text, deadline = '', notes = '', category = 'General', isDaily = false, isCompleted = false, isUrgent = false, id: docId } = taskData;
            
            const taskItem = document.createElement('div');
            taskItem.classList.add('task-item');
            taskItem.dataset.daily = isDaily;
            taskItem.dataset.completed = isCompleted;
            taskItem.dataset.deadline = deadline;
            taskItem.dataset.notes = notes;
            taskItem.dataset.category = category;
            taskItem.dataset.urgent = isUrgent;
            taskItem.dataset.docId = docId;

            const taskContentDiv = document.createElement('div');
            taskContentDiv.classList.add('task-content');

            const taskSpan = document.createElement('h3');
            taskSpan.classList.add('task-text');
            taskSpan.textContent = text;
            taskContentDiv.appendChild(taskSpan);

            const deadlineDisplay = document.createElement('p');
            deadlineDisplay.classList.add('task-deadline');
            if (deadline) {
                const date = new Date(deadline + 'T00:00:00');
                deadlineDisplay.textContent = `Due: ${date.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' })}`;
            } else {
                deadlineDisplay.textContent = 'No deadline';
            }
            deadlineDisplay.onclick = () => editDate(taskItem, deadlineDisplay);
            taskContentDiv.appendChild(deadlineDisplay);

            if (category && category !== 'General') {
                const categorySpan = document.createElement('span');
                categorySpan.classList.add('task-category');
                categorySpan.textContent = category;
                taskContentDiv.appendChild(categorySpan);
            }

            if (notes) {
                const notesDisplayDiv = document.createElement('div');
                notesDisplayDiv.classList.add('task-notes');
                notesDisplayDiv.textContent = notes;
                taskContentDiv.appendChild(notesDisplayDiv);
            }

            taskItem.appendChild(taskContentDiv);

            const actionsDiv = document.createElement('div');
            actionsDiv.classList.add('task-actions');

            const completeBtn = document.createElement('button');
            completeBtn.textContent = isCompleted ? 'Undo' : 'Complete';
            completeBtn.classList.add(
                isCompleted ? 'bg-yellow-500' : 'bg-green-500',
                'text-white',
                'hover:bg-green-600',
                'hover:bg-yellow-600',
                'focus:outline-none',
                'focus:ring-2',
                'focus:ring-offset-2',
                'focus:ring-green-500'
            );
            completeBtn.onclick = () => toggleComplete(taskItem);
            actionsDiv.appendChild(completeBtn);

            if (!isCompleted && !isUrgent) {
                const moveBtn = document.createElement('button');
                moveBtn.textContent = isDaily ? 'Move to Pending' : 'Move to Daily';
                moveBtn.classList.add(
                    isDaily ? 'bg-purple-500' : 'bg-indigo-500',
                    'text-white',
                    'hover:bg-purple-600',
                    'hover:bg-indigo-600',
                    'focus:outline-none',
                    'focus:ring-2',
                    'focus:ring-offset-2',
                    'focus:ring-purple-500'
                );
                moveBtn.onclick = () => moveTask(taskItem);
                actionsDiv.appendChild(moveBtn);
            }
            
            if (!isCompleted && !isUrgent) {
                const urgentBtn = document.createElement('button');
                urgentBtn.textContent = 'Make Urgent';
                urgentBtn.classList.add('bg-red-600', 'text-white', 'hover:bg-red-700', 'focus:outline-none', 'focus:ring-2', 'focus:ring-offset-2', 'focus:ring-red-600');
                urgentBtn.onclick = () => makeUrgent(taskItem);
                actionsDiv.appendChild(urgentBtn);
            }

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            deleteBtn.classList.add(
                'bg-red-500',
                'text-white',
                'hover:bg-red-600',
                'focus:outline-none',
                'focus:ring-2',
                'focus:ring-offset-2',
                'focus:ring-red-500'
            );
            deleteBtn.onclick = () => deleteTask(taskItem);
            actionsDiv.appendChild(deleteBtn);

            taskItem.appendChild(actionsDiv);
            return taskItem;
        }

        async function editDate(taskItem, deadlineDisplayElement) {
            if (taskItem.dataset.completed === 'true') {
                alert("Cannot edit the deadline of a completed task.");
                return;
            }

            const oldDeadline = taskItem.dataset.deadline || '';
            
            const dateInput = document.createElement('input');
            dateInput.type = 'date';
            dateInput.value = oldDeadline;
            dateInput.classList.add('p-1', 'border', 'rounded', 'text-gray-700', 'focus:outline-none', 'focus:ring-2', 'focus:ring-blue-500');
            dateInput.addEventListener('change', async (e) => {
                const newDeadline = e.target.value;
                if (newDeadline !== oldDeadline) {
                    await updateTaskDeadline(taskItem, newDeadline);
                }
                deadlineDisplayElement.textContent = newDeadline ? `Due: ${new Date(newDeadline + 'T00:00:00').toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' })}` : 'No deadline';
                deadlineDisplayElement.onclick = () => editDate(taskItem, deadlineDisplayElement);
            });
            dateInput.addEventListener('blur', () => {
                deadlineDisplayElement.textContent = oldDeadline ? `Due: ${new Date(oldDeadline + 'T00:00:00').toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' })}` : 'No deadline';
                deadlineDisplayElement.onclick = () => editDate(taskItem, deadlineDisplayElement);
            });

            deadlineDisplayElement.parentNode.replaceChild(dateInput, deadlineDisplayElement);
            dateInput.focus();
        }

        async function updateTaskDeadline(taskItem, newDeadline) {
            if (!authReady || !taskItem.dataset.docId) return;

            const docRef = doc(db, `artifacts/${appId}/public/data/tasks`, taskItem.dataset.docId);

            try {
                await updateDoc(docRef, {
                    deadline: newDeadline
                });
            } catch (error) {
                console.error("Error updating deadline:", error);
                alert("Failed to update deadline. See console for details.");
            }
        }


        async function addTask() {
            if (!authReady) return;

            const taskText = document.getElementById('newTaskInput').value.trim();
            const taskDeadline = document.getElementById('taskDeadlineInput').value;
            const taskCategory = document.getElementById('taskCategoryInput').value;
            const taskNotes = '';

            if (taskText === '') {
                alert('Please enter a task!');
                return;
            }

            try {
                const tasksCollectionRef = collection(db, `artifacts/${appId}/public/data/tasks`);
                await addDoc(tasksCollectionRef, {
                    text: taskText,
                    deadline: taskDeadline,
                    notes: taskNotes,
                    category: taskCategory,
                    isDaily: true,
                    isCompleted: false,
                    isUrgent: false, // New field for urgent tasks
                    createdAt: serverTimestamp()
                });
                document.getElementById('newTaskInput').value = '';
                document.getElementById('taskDeadlineInput').value = '';
                document.getElementById('taskCategoryInput').value = 'General';
            } catch (error) {
                console.error("Error adding document: ", error);
                alert("Failed to add task. See console for details.");
            }
        }

        async function toggleComplete(taskItem) {
            if (!authReady || !taskItem.dataset.docId) return;

            const docRef = doc(db, `artifacts/${appId}/public/data/tasks`, taskItem.dataset.docId);
            const isCompleted = taskItem.dataset.completed === 'true';

            try {
                await updateDoc(docRef, {
                    isCompleted: !isCompleted
                });
            } catch (error) {
                console.error("Error updating document: ", error);
                alert("Failed to update task status. See console for details.");
            }
        }

        async function moveTask(taskItem) {
            if (!authReady || !taskItem.dataset.docId) return;

            const docRef = doc(db, `artifacts/${appId}/public/data/tasks`, taskItem.dataset.docId);
            const isDaily = taskItem.dataset.daily === 'true';

            try {
                await updateDoc(docRef, {
                    isDaily: !isDaily,
                    isUrgent: false // Ensure it's not urgent if moved to daily/pending
                });
            } catch (error) {
                console.error("Error moving document: ", error);
                alert("Failed to move task. See console for details.");
            }
        }

        async function makeUrgent(taskItem) {
            if (!authReady || !taskItem.dataset.docId) return;

            const docRef = doc(db, `artifacts/${appId}/public/data/tasks`, taskItem.dataset.docId);
            try {
                await updateDoc(docRef, {
                    isUrgent: true,
                    isDaily: false // Urgent tasks are not daily or pending
                });
            } catch (error) {
                console.error("Error making task urgent:", error);
                alert("Failed to mark task as urgent. See console for details.");
            }
        }

        async function deleteTask(taskItem) {
            if (!authReady || !taskItem.dataset.docId) return;

            const docRef = doc(db, `artifacts/${appId}/public/data/tasks`, taskItem.dataset.docId);

            try {
                await deleteDoc(docRef);
            } catch (error) {
                console.error("Error deleting document: ", error);
                alert("Failed to delete task. See console for details.");
            }
        }
        
        function exportTasksToCsv() {
            if (allTasksData.length === 0) {
                alert("No tasks to export!");
                return;
            }

            const headers = ["Task", "Deadline", "Category", "Notes", "Is Daily", "Is Completed", "Created At", "Is Urgent"];
            let csv = headers.join(",") + "\n";

            allTasksData.forEach(task => {
                const row = [
                    `"${task.text.replace(/"/g, '""')}"`,
                    task.deadline || '',
                    task.category || 'General',
                    `"${task.notes ? task.notes.replace(/"/g, '""') : ''}"`,
                    task.isDaily ? 'TRUE' : 'FALSE',
                    task.isCompleted ? 'TRUE' : 'FALSE',
                    task.isUrgent ? 'TRUE' : 'FALSE',
                    task.createdAt ? new Date(task.createdAt.toDate()).toLocaleString() : ''
                ];
                csv += row.join(",") + "\n";
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "tasks.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } else {
                alert("Your browser does not support downloading files directly. Please copy the data manually.");
            }
        }

        window.openNotesModal = function(taskItem) {
            currentTaskItemForNotes = taskItem;
            document.getElementById('editNotesTextarea').value = taskItem.dataset.notes || '';
            document.getElementById('notesModal').style.display = 'flex';
        }

        window.closeNotesModal = function() {
            document.getElementById('notesModal').style.display = 'none';
            currentTaskItemForNotes = null;
        }

        window.saveNotes = async function() {
            if (!authReady || !currentTaskItemForNotes || !currentTaskItemForNotes.dataset.docId) return;

            const docRef = doc(db, `artifacts/${appId}/public/data/tasks`, currentTaskItemForNotes.dataset.docId);
            const newNotes = document.getElementById('editNotesTextarea').value.trim();

            try {
                await updateDoc(docRef, { notes: newNotes });
            }  catch (error) {
                console.error("Error saving notes: ", error);
                alert("Failed to save notes. See console for details.");
            } finally {
                window.closeNotesModal();
            }
        }

        document.getElementById('addTaskBtn').addEventListener('click', addTask);
        document.getElementById('exportTasksBtn').addEventListener('click', exportTasksToCsv);

        document.getElementById('newTaskInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addTask();
        });
        document.getElementById('taskDeadlineInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addTask();
        });
        document.getElementById('taskCategoryInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addTask();
        });

        window.onload = initializeFirebase;
    </script>
</body>
</html>
